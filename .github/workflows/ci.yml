name: CI

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  build:
    runs-on: ubuntu-22.04
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential cmake g++ libntl-dev libgmp-dev git
      
      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
      
      - name: Build SEAL library
        run: |
          cd /tmp
          git clone https://github.com/microsoft/SEAL.git
          cd SEAL && git checkout v4.1.1
          cmake -S . -B build -DCMAKE_BUILD_TYPE=Release -DSEAL_USE_MSGSL=OFF -DSEAL_USE_ZLIB=OFF
          cmake --build build -j$(nproc)
          sudo cmake --install build
          sudo ldconfig
      
      - name: Build HElib library
        run: |
          cd /tmp
          git clone https://github.com/homenc/HElib.git
          cd HElib && git checkout v2.3.0
          mkdir -p build && cd build
          cmake -DCMAKE_BUILD_TYPE=Release -DCMAKE_INSTALL_PREFIX=/usr/local ..
          make -j$(nproc)
          sudo make install
          sudo ldconfig

      - name: Clean build directories
        run: |
          rm -rf cpp_wrapper/build
          rm -rf helib_wrapper/build
      
      - name: Build SEAL wrapper
        run: |
          cd cpp_wrapper
          mkdir -p build && cd build
          cmake ..
          make -j$(nproc)
      
      - name: Build HElib wrapper
        run: |
          cd helib_wrapper
          mkdir -p build && cd build
          cmake ..
          make -j$(nproc)
          
      - name: Build Rust project
        run: |
          export LD_LIBRARY_PATH="$PWD/cpp_wrapper/build:$PWD/helib_wrapper/build:/usr/local/lib"
          cargo build --verbose
      
      - name: Run tests
        run: |
          export LD_LIBRARY_PATH="$PWD/cpp_wrapper/build:$PWD/helib_wrapper/build:/usr/local/lib"
          cargo test --verbose --lib
        continue-on-error: true